<script>
  import Footer from "./lib/common/Footer.svelte";
  import LoginBox from "./lib/login/LoginBox.svelte";
  import RegisterBox from "./lib/login/RegisterBox.svelte";
  import Loading from "./lib/common/Loading.svelte";
  import WantLogin from "./lib/login/WantLogin.svelte";
  import Toast from "./lib/common/notifications/Toast.svelte";
  import { SvelteToast } from "@zerodevx/svelte-toast";
  import Home from "./lib/home/Home.svelte";
  import { onMount } from "svelte";
  import { getCookie, verify } from "./lib/common/api";

  let isLoading = true;
  let wantLogin = true;
  let isLogged = false;

  let username = "";
  let password = "";
  let passwordConfirmation = "";

  onMount(() => {
    // Get token based on cookie then change isLogged variable
    let token = getCookie("token");
    if (token) {
      verify(token)
        .then((response) => {
          if (response.auth) {
            isLogged = true;
            // Get information form jwt token
            username = response.username;
          }
        })
        .finally(() => {
          isLoading = false;
        });
    } else {
      isLoading = false;
    }
  });
</script>

{#if isLoading}
  <Loading />
{:else if !isLogged}
  <main>
    <h1>Examinator 3001</h1>
    {#if wantLogin}
      <LoginBox bind:username bind:password bind:isLoading bind:isLogged />
    {:else}
      <RegisterBox
        bind:username
        bind:password
        bind:isLoading
        bind:isLogged
        bind:passwordConfirmation
      />
    {/if}
    <WantLogin bind:wantLogin />
    <Footer />
  </main>
  <Toast />
{:else}
  <Home bind:isLoading bind:username />
  <Toast />
{/if}
<SvelteToast />
